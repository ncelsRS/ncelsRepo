@using PW.Ncels.Database.Constants
@model PW.Ncels.Database.Models.OBK.ZBKViewModel

@{
    Layout = "../Shared/_Layout.cshtml";

    int? total = 0;
    if (Model.CopyQuantity != null)
    {
        total = 219 * Model.CopyQuantity * 2;
    }

    int? totalWithNDS = 0;
    if (Model.CopyQuantity != null)
    {
        var sum = 219 * Model.CopyQuantity * 1.12;
        totalWithNDS = (int?)sum;
    }

}
@Html.Partial("~/Views/Home/SignView.cshtml")

@Html.HiddenFor(o => o.AttachPath)
@Html.HiddenFor(o => o.PaymentInvoice)


<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-12">
        <h2>Все</h2>
        <ol class="breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">Домашняя страница</a>
            </li>
            <li>
                <a>Сертификаты ЗБК</a>
            </li>
            <li class="active">
                <strong>Запрос на копию</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5 id="safetyTitle">
                        Заключение о безопасности и качества продукции
                    </h5>
                    @{ if (Model.PaymentInvoice == true)
                        {
                            <br>
                            <div class="row">
                                <div class="col-lg-3 col-lg-offset-2">
                                    <button type="button" class="btn btn-info btn-md" data-toggle="modal" data-target="#myModal">Счет на оплату</button>
                                </div>

                                @if (Model.refStatus == CodeConstManager.STATUS_OBK_SIGN_ACT)
                                {
                                <div class="row">
                                    <div class="col-lg-3">
                                        <button type="button" class="btn btn-info btn-md" data-toggle="modal" data-target="#actModal">Акт выполненных работ</button>
                                    </div>
                                </div>
                                }

                            </div>

                         
                        }
                        else
                        {
                            <br>
                            <div class="row">
                                <div class="col-lg-6 col-lg-offset-6"><button class="btn btn-success dropdown-toggle" id="signBtn">Подписать ЭЦП и отправить в ЦОЗ</button></div>
                            </div>
                        }
                    }

                    @{ if (Model.Notes != null)
                        {
                            <textarea style="width: 700px; height: 200px; background-color: #f3cdcd" placeholder="Замечания" id="notes" disabled="disabled">@Model.Notes</textarea>
                            <br>
                        }}

                    <label style="color: black;">Данные заключения</label>

                    <br>
                    <div style="margin:5px;">
                        <div class="row">
                            <div class="col-lg-6">
                                <label>Заявитель</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.Declarer, new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label>Наименование организации</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.OrganizationName, new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <label>№ заключения</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.ConclusionNumber, new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label>№ договора</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.ContractNumber, new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <label>Дата выдачи</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.StartDate, "{0:dd.MM.yyyy}", new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label>№ заявки</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.DeclarationNumber, new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <label>Дата истечения</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.ExpireDate, "{0:dd.MM.yyyy}", new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <label>Тип заявки</label>
                                <div class="input-group" style="width:100%">
                                    @Html.TextBoxFor(model => model.DeclarationType, new { @class = "form-control edit-control", placeholder = "Введите значение", disabled = "disabled" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <label> Тип заключения</label>
                                <div class="input-group" style="width:100%">
                                    @{
                                        if (Model.ExpApplication == true)
                                        {
                                            <input value="с приложением" disabled="disabled" class="form-control edit-control">
                                        }
                                        else
                                        {
                                            <input value="без приложением" disabled="disabled" class="form-control edit-control">
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-lg-12">
                                <label style="color:black">Продукция</label>
                                <br>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <table id="products" dt-options="dtOptions" dt-columns="dtColumns" class="table table-striped table-bordered table-hover dataTable"></table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-lg-12">
                                <label>Прикрепить файл</label>
                                <div class="input-group">
                                    <input name="files" id="@("files" + Model.Id)" type="file" title="@PW.Ncels.Database.Recources.Messages.ВыбратьФайл" />
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-lg-2">
                                <label id="copyQuantity-label">Количество копий*</label>
                            </div>
                            <div class="col-lg-10">
                                <div class="input-group">
                                    <input id="copyQuantity" value="@Model.CopyQuantity" style="width:50px;" class="copyQuantity-control" type="number" />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <label style="color:black">Стоимость услуги</label>
                                <br>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <table id="productsCost" dt-options="dtOptions" dt-columns="dtColumns" class="table table-striped table-bordered table-hover dataTable">
                                            <thead>
                                                <tr>
                                                    <th>Наименование услуги</th>
                                                    <th>Единица измерения</th>
                                                    <th>Цена тенге без НДС</th>
                                                    <th>Количество услуг</th>
                                                    <th>Количество приложении</th>
                                                    <th>Итоговая стоимость услуги, в тенге без НДС</th>
                                                    <th>Итоговая стоимость услуги, в тенге с НДС</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Оформление копий заключения о безопасности и качества</td>
                                                    <td>1 копия</td>
                                                    <td id="onePrice">219</td>
                                                    <td id="copyQuantityTable">@Model.CopyQuantity</td>
                                                    <td id="copyQuantityTable2">@Model.CopyQuantity</td>
                                                    <td id="totalWithoutNds">@( total )</td>
                                                    <td id="totalWithNds">@( totalWithNDS  )</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="myModal" role="dialog">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title">Счет на оплату</h4>
                                    </div>
                                    <div class="modal-body">
                                        <object data="/ZBKCopy/DocumentZbkCopyPdf?zbkCopyId=@Model.Id&contractId=@ViewData["ContractId"]" type="application/pdf" style="width:100%;height:550px"></object>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="actModal" role="dialog">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title">Акт выполненных работ</h4>
                                    </div>
                                    <div class="modal-body">
                                        <object data="/ZBKCopy/CertOfComplectFilePdf?zbkCopyId=@Model.Id" type="application/pdf" style="width:100%;height:550px"></object>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    $(document).ready(function () {
        fillProductsTable();

        var fileId = '@Model.Id';

        InitializeZBKCopyFile(fileId);

        if ($("#PaymentInvoice").val() == 'True')
        {
            $("#copyQuantity").attr("disabled", "disabled");
        }
    });

    $(".copyQuantity-control").change(function () {
        var copyQuantity = $("#copyQuantity").val();
        $("#copyQuantityTable").html(copyQuantity);
        $("#copyQuantityTable2").html(copyQuantity);
        $("#totalWithoutNds").html(copyQuantity * 219 * 2);
        $("#totalWithNds").html(parseInt(copyQuantity * 219 * 2 * 1.12));
    });



    function fillProductsTable() {
        $.ajax({
            type: 'POST',
            url: '/ZBKCopy/Products?contractId=' + '@Model.ContractId',
            success: function (data) {
                if (data.success == true) {
                    initProductsTable(data.result);
                }
            }
        });
    }

    function initProductsTable(data) {
        $("#products").DataTable({
            autoWidth: false,
            searching: false,
            paging: false,
            bInfo: false,
            data: data,
            "columns": [
                { data: 'name', sWidth: "50px", title: "Наименование" },
                { data: 'fullName', sWidth: "20px", title: "Полное наименование" },
                { data: 'producerName', sWidth: "50px", title: "Производитель" },
                { data: 'serieParty', sWidth: "50px", title: "Кол-во в потр.уп." },
                { data: 'country', sWidth: "50px", title: "Страна-производитель" },
            ]
        });
    }


    function checkValidation() {
         var valid = true;
         valid = checkAttr("copyQuantity", valid);

         if(valid == false){
            alert("Заполните обязательные поля!");
         }
         return valid;
    }

    function checkAttr(attr, valid) {
        var val = $("#" + attr + "").val();
        if (val == "") {
            $("#" + attr + "-label").css({ 'color': '#a94442' });
            valid = false;
        } else {
            $("#" + attr + "-label").css({ 'color': '#555' });
        }
        return valid;
    }

</script>

<script src="~/Scripts/js/custom/common.js"></script>
<script src="~/Scripts/js/custom/spin.js"></script>
<script src="~/Scripts/photon/crypto/obk/obk_eds.js"></script>
<script type="text/javascript">

       $("#signBtn").click(function () {

    if(checkValidation()){
    var id = '@Model.Id';
           if (id) {
               var funcSign = function signData() {
                   debugger;
                   $.blockUI({ message: '<h1><img src="../../Content/css/plugins/slick/ajax-loader.gif"/> Выполняется подпись...</h1>', css: { opacity: 1 } });
                   signXmlCall(function () {
                       debugger;

        $.ajax({
            type: 'POST',
            url: '/ZBKCopy/SaveSignedZBKCopy',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({ id: id, signedData: $("#Certificate").val() }),
            success: function (result) {
                alert(result.message);
                 $.unblockUI();
                $.ajax({
                    type: 'POST',
                    url: '/ZBKCopy/Update',
                    data: {id:id, quantity: $("#copyQuantity").val()},
                    success: function (data){
                        if(data.success == true){
                             window.location.href="/ZBKCopy/Index";
                        }
                    }
                });
            }
        });

                   });
               };

               startSign('/ZBKCopy/SignData', id, funcSign);
           }
    }


       });

</script>

